<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬ed - Loading</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #e5e5e5;
            overflow: hidden;
        }

        .logo-container {
            margin-bottom: 40px;
            animation: pulse 2s infinite ease-in-out;
        }

        .logo {
            width: 80px;
            height: 60px;
            color: #7662cf;
        }

        .app-name {
            font-size: 28px;
            font-weight: 700;
            margin-top: 15px;
            color: #e5e5e5;
            text-align: center;
        }

        .status-container {
            text-align: center;
            margin-top: 20px;
        }

        .status-text {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 20px;
            min-height: 20px;
        }

        .progress-container {
            width: 200px;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #7662cf, #9f7aea);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-bar.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s infinite ease-in-out;
        }

        .debug-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #ccc;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .debug-toggle {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #7662cf;
            border: 1px solid #7662cf;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }

        .debug-toggle:hover {
            background: #9f7aea;
            border-color: #9f7aea;
        }

        .version {
            position: absolute;
            bottom: 20px;
            font-size: 12px;
            color: #666;
        }

        .error {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(333%); }
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <svg class="logo" viewBox="0 0 280 200" xmlns="http://www.w3.org/2000/svg">
            <!-- Horizontal bar -->
            <rect x="12.3" y="20" width="255.4" height="80.2" rx="29.25" fill="currentColor"/>
            <!-- Vertical bar -->
            <rect x="210.3" y="23" width="77.4" height="173" rx="29.25" fill="currentColor"/>
            <!-- Bottom bar -->
            <rect x="12.3" y="115.8" width="186.6" height="80" rx="29.25" fill="currentColor"/>
        </svg>
        <div class="app-name">not|ed</div>
    </div>

    <div class="status-container">
        <div class="status-text" id="status">Initializing...</div>
        <div class="progress-container">
            <div class="progress-bar indeterminate" id="progress"></div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <div class="version" id="version">v1.0.13</div>
    
    <div class="debug-info" id="debug-info"></div>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    <button class="debug-toggle" onclick="debugFetchReleases()" style="right: 80px; background: #e53e3e;">Fetch API</button>

    <script>
        const { ipcRenderer } = require('electron');

        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');
        const errorEl = document.getElementById('error');
        const versionEl = document.getElementById('version');
        const debugEl = document.getElementById('debug-info');
        
        let debugMessages = [];
        
        function toggleDebug() {
            debugEl.classList.toggle('show');
        }
        
        async function debugFetchReleases() {
            addDebugMessage('🔍 Fetching GitHub releases API...');
            
            try {
                const result = await ipcRenderer.invoke('debug-fetch-releases');
                
                if (result.error) {
                    addDebugMessage('❌ API Error: ' + result.error);
                    if (result.rawData) {
                        addDebugMessage('Raw response: ' + result.rawData.substring(0, 200) + '...');
                    }
                } else {
                    addDebugMessage('✅ API Success!');
                    addDebugMessage(`Current: ${result.currentVersion}`);
                    addDebugMessage(`Latest: ${result.latestVersion}`);
                    addDebugMessage(`Published: ${result.publishedAt}`);
                    addDebugMessage(`Assets: ${result.assetsCount}`);
                    addDebugMessage(`isDev: ${result.isDev}`);
                    addDebugMessage(`isPackaged: ${result.isPackaged}`);
                    
                    // Version comparison
                    const current = result.currentVersion.replace('v', '');
                    const latest = result.latestVersion.replace('v', '');
                    addDebugMessage(`Comparison: ${current} vs ${latest}`);
                    
                    if (current === latest) {
                        addDebugMessage('🟡 Versions are equal - no update needed');
                    } else {
                        addDebugMessage('🟢 Versions differ - update should be available');
                    }
                }
            } catch (error) {
                addDebugMessage('💥 Debug fetch failed: ' + error.message);
            }
        }
        
        function addDebugMessage(msg) {
            debugMessages.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
            if (debugMessages.length > 20) {
                debugMessages = debugMessages.slice(-20);
            }
            debugEl.innerHTML = debugMessages.join('<br>');
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // Set version from main process
        ipcRenderer.invoke('get-app-version').then(version => {
            versionEl.textContent = `v${version}`;
            addDebugMessage(`App version: ${version}`);
        });

        // Add initial debug info
        addDebugMessage('Splash screen initialized');
        addDebugMessage('Waiting for environment info...');
        
        // Show debug window by default for testing
        setTimeout(() => {
            debugEl.classList.add('show');
            // Auto-fetch releases info for debugging
            setTimeout(() => {
                debugFetchReleases();
            }, 1000);
        }, 500);

        // Update status messages
        ipcRenderer.on('splash-status', (event, message) => {
            statusEl.textContent = message;
        });

        // Update progress
        ipcRenderer.on('splash-progress', (event, percent) => {
            if (percent >= 0) {
                progressEl.classList.remove('indeterminate');
                progressEl.style.width = percent + '%';
            } else {
                progressEl.classList.add('indeterminate');
                progressEl.style.width = '30%';
            }
        });

        // Listen for debug messages
        ipcRenderer.on('splash-debug', (event, message) => {
            addDebugMessage(message);
        });

        // Show error
        ipcRenderer.on('splash-error', (event, message) => {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            statusEl.textContent = 'Error occurred';
        });

        // Close splash and show main app
        ipcRenderer.on('splash-close', () => {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                ipcRenderer.send('splash-finished');
            }, 500);
        });

        // Ready
        ipcRenderer.send('splash-ready');
    </script>
</body>
</html>
